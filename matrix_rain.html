<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Matrix Code Rain</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      /* ===== Customization ===== */
      --bg-color: #000000;       /* Background color */
      --glyph-color: #00ff7f;    /* Glyph color (Matrix green: #00ff7f or #00ff41) */
      --glow-strength: 0.6;      /* 0–1: intensity of glow */
      --font-size: 18;           /* Base character size in px */
      --speed: 1.0;              /* 0.5 slow, 1.0 normal, 2.0 fast */
      --density: 0.9;            /* 0.2 sparse, 0.9 dense */
      --trail-length: 30;        /* 10 short, 30 long trails */
      --random-charset: "アカサタナハマヤラワ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      --fade-top: 0.08;          /* Start fade near top (0–0.3) */
    }

    html, body, canvas {
      margin: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-color);
      overflow: hidden;
    }

    /* Optional subtle vignette for depth */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(ellipse at center,
        rgba(0,0,0,0) 40%,
        rgba(0,0,0,0.25) 100%);
    }
  </style>
</head>
<body>
  <canvas id="matrix"></canvas>

  <script>
    (() => {
      const canvas = document.getElementById("matrix");
      const ctx = canvas.getContext("2d");

      // Read CSS variables
      const css = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
      let glyphColor = css("--glyph-color") || "#00ff7f";
      let glowStrength = parseFloat(css("--glow-strength") || "0.6");
      let baseFontSize = parseInt(css("--font-size") || "18", 10);
      let speedFactor = parseFloat(css("--speed") || "1.0");
      let density = parseFloat(css("--density") || "0.9");
      let trailLength = parseInt(css("--trail-length") || "30", 10);
      let charset = (css("--random-charset") || "01").replace(/(^"|"$)/g, "");
      let fadeTop = parseFloat(css("--fade-top") || "0.08");

      let width, height, columnWidth, columns, drops, fontSize;
      let lastTime = performance.now();

      // Resize handling
      function resize() {
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1)); // cap DPR for perf
        width = canvas.clientWidth = window.innerWidth;
        height = canvas.clientHeight = window.innerHeight;
        canvas.width = Math.floor(width * dpr);
        canvas.height = Math.floor(height * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        fontSize = baseFontSize;
        columnWidth = fontSize;
        columns = Math.floor(width / columnWidth);

        drops = new Array(columns);
        for (let i = 0; i < columns; i++) {
          // Start each drop at a random row to avoid uniformity
          drops[i] = Math.floor(Math.random() * height / fontSize);
        }

        ctx.font = `${fontSize}px monospace`;
        ctx.textBaseline = "top";
      }

      window.addEventListener("resize", resize, { passive: true });
      resize();

      // Utility: get random glyph
      function randomGlyph() {
        const idx = Math.floor(Math.random() * charset.length);
        return charset.charAt(idx);
      }

      // Draw frame
      function frame(now) {
        const dt = Math.min(0.05, (now - lastTime) / 1000); // clamp delta
        lastTime = now;

        // Faint translucent overlay to create trail fade
        const fadeStrength = Math.max(0.04, 0.9 / trailLength);
        ctx.fillStyle = `rgba(0, 0, 0, ${fadeStrength})`;
        ctx.fillRect(0, 0, width, height);

        // Glow effect
        ctx.shadowColor = glyphColor;
        ctx.shadowBlur = 20 * glowStrength;

        // Draw glyphs for each column
        for (let i = 0; i < columns; i++) {
          // Density: probabilistic skip for sparsity
          if (Math.random() > density) continue;

          const x = i * columnWidth;
          const y = drops[i] * fontSize;

          // Fade near the top to avoid harsh start
          const alpha = y < height * fadeTop ? (y / (height * fadeTop)) : 1;
          ctx.fillStyle = `rgba(${hexToRgb(glyphColor)}, ${alpha})`;

          // Leading glyph brighter
          ctx.shadowBlur = 30 * glowStrength;
          ctx.fillText(randomGlyph(), x, y);

          // Trail glyphs (slightly dimmer)
          ctx.shadowBlur = 10 * glowStrength;
          for (let t = 1; t < Math.min(6, trailLength / 6); t++) {
            const ty = y - t * fontSize;
            if (ty < 0) break;
            const trailAlpha = Math.max(0.1, alpha * (1 - t / trailLength));
            ctx.fillStyle = `rgba(${hexToRgb(glyphColor)}, ${trailAlpha})`;
            ctx.fillText(randomGlyph(), x, ty);
          }

          // Move drop down; when past bottom, reset at random row
          drops[i] += Math.max(1, speedFactor) * (1 + Math.random() * 0.5);
          if (y > height + fontSize * 2) {
            drops[i] = Math.floor(Math.random() * height / fontSize * 0.5);
          }
        }

        requestAnimationFrame(frame);
      }

      // Convert hex color to "r, g, b"
      function hexToRgb(hex) {
        const h = hex.replace("#", "");
        const bigint = parseInt(h.length === 3 ? h.split("").map(c => c+c).join("") : h, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return `${r}, ${g}, ${b}`;
      }

      requestAnimationFrame(frame);

      // Optional: keyboard controls for quick tuning
      // [+/-] speed | [ ] density | [ ] trail
      window.addEventListener("keydown", (e) => {
        if (e.key === "+") speedFactor = Math.min(4, speedFactor + 0.1);
        if (e.key === "-") speedFactor = Math.max(0.3, speedFactor - 0.1);
        if (e.key.toLowerCase() === "d") density = Math.min(1, density + 0.05);
        if (e.key.toLowerCase() === "s") density = Math.max(0.1, density - 0.05);
        if (e.key.toLowerCase() === "t") trailLength = Math.min(60, trailLength + 2);
        if (e.key.toLowerCase() === "g") trailLength = Math.max(8, trailLength - 2);
      });
    })();
  </script>
</body>
</html>